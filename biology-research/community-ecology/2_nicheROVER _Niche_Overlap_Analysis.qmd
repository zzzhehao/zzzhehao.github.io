---
title: Niche Overlap Analysis using stable isotope data and nicheROVER
draft: true
abstract: Stable isotope analysis (SIA) provides numerous information while assessing species' ecological niche, the R package *nicheROVER* offers an insightful analysis using stable isotope data.
categories:
  - Ecology
  - Community Ecology
  - Data Analysis
  - Multivariate Analysis
filters:
  - openlinksinnewpage
execute:
  echo: true
number headings: auto, first-level 3, max 4, 2
---

<br>

::: {.disclaimer}
This is a note from the course *Community Ecology* offered by [University of Hamburg](https://www.biologie.uni-hamburg.de/en.html) and led by [Dr. Paula Cabral Eterovick](https://www.researchgate.net/profile/Paula-Eterovick-2). 
:::

<br>

## Niche Overlap

In my previous note, [Ecological Niche](/biology-research/community-ecology/Ecological-Niche.qmd), we talked about the basic ideas about the ecological niche and niche overlap. Understanding the niche overlap pattern, both intraspecific and interspecific, can help us obtain more insight into many topics, such as:

Evolutionary:

- **Sexual Dimorphism** by study difference in resource utilizing between males and females of the same species.
- **Speciation Process** by study niche partitioning between sister taxa or subspecies.

Conservation:

- **Impact of the Invasive Species** by looking at the niche overlap between native and invasive species.
- **Ecological Guild** by understanding niche overlap within a group sharing same or similar functional trait (e.g. pollinator communities).

However, comparing niches among multiple species is challenging, as I mentioned already, since the ecological data are almost always multidimensional.

## `nicheROVER`

The package `nicheROVER` provides a new probabilistic method for quantifying n-dimensional ecological niche and niche overlap [@swanson2015]. The script demonstrated here is written by Martin Lysy, Heidi Swanson (see [here](https://cran.r-project.org/web/packages/nicheROVER/vignettes/ecol-vignette.html)), also used in the publication for the method demonstration.  

`fish` is a **fish stable isotope dataset** coming along in the package, containing values for three stable isotopes (N-15, C-13, S-34) measured in the muscle tissue of four arctic fish species (ARCS, BDWF, LKWF, LSCS), more details can be found from the documentation (`?fish`) or in the publication.

```{r}
#| label: setup
#| echo: false
#| output: false
pacman::p_load(c("rmarkdown", "knitr", "tidyverse", "nicheROVER", "gtsummary"), character.only = TRUE)
```

```{r}
library(nicheROVER)
data(fish)
```

```{r}
#| echo: false
#| label: tbl-fish
#| tbl-cap: \`fish\` dataset

paged_table(fish)
```

## What is SIA?

**Stable isotope analysis (SIA)** is a powerful tool in ecological niche analysis. Many physicochemical and biochemical processes are sensitive to differences in the dissociation energies of molecules, which often depend on the mass of the elements from which these molecules are made. Thus, the isotopic composition of many materials (expressed as $\delta$-values), including the tissues of organisms, often contains a label of the process that created it [@newsome2007a]. These "signatures" provides detailed insights into their ecological roles and interactions.

| Gradient                               | Isotope system                                     | High $\delta$-values | Low $\delta$-values  |
| -------------------------------------- | -------------------------------------------------- | -------------------- | -------------------- |
| Trophic level                          | $\delta ^{13} C$/$\delta ^{15} N$                  | High levels          | Low levels           |
| C<sub>3</sub>-C<sub>4</sub> Vegetation | $\delta ^{13} C$                                   | C<sub>4</sub> plants | C<sub>3</sub> plants |
| Marine-terrestrial                     | $\delta ^{15} N$/$\delta ^{13} C$/$\delta ^{34} S$ | High levels          | Low levels           |

: A few common isotope systems and expected patterns in $\delta$-values, subsetted from [@newsome2007a] {#tbl-SIAs}

<br>

::: {.callout-note title="For more information about isotopic and atomic ecology" collapse="true"}

- @newsome2007a
- @michel2021
- @moyo2021
- @2024

:::

## Statistic Priors

Before we start analyzing our data, there are some concepts and prior knowledge need to be checked. Since this is the first note associating with statistics in my post, I will elaborate things a bit more detailed.

### Bayesian statistics

@vandeschoot2021 described the very foundation idea of the Bayesian statistics as following:

Bayesian statistics is an approach to data analysis based on Bayes' theorem, where available knowledge about parameters in a statistical model is updated with the information in observed data. The background knowledge is expressed as a **prior** distribution and combined with observational data in the form of a likelihood function to determine the **posterior distribution**.

The Bayesian statistics is based on the **Bayes' theorem**, which is mathematically stated as following:

$$
P(A|B)=\frac{P(B|A)P(A)}{P(B)}
$$

where,

- $A$ and $B$ are events and $P(B)\neq 0$,
- $P(A|B)$: the probability of event $A$ occurring given that $B$ is true. It is also called the **posterior probability** (briefly *posterior*) of $A$ given $B$.
- $P(B|A)$ is also a conditional probability: the probability of event $B$ occurring given that $A$ is true. It can also be interpreted as the likelihood of $A$ given a fixed $B$ because $P(B|A)=L(A|B)$. ($L$: likelihood)
- $P(A)$ and $P(B)$ are the probabilities of observing $A$ and $B$ respectively without any given conditions; they are known as the **prior probability** and marginal probability.

#### Why Bayesian Statistics?

Bayesian statistics is a whole other framework and approach on statistical analysis by putting the Bayes' theorem at the center. Both classical and Bayesian inference, while trying to modelling data, have advantages and disadvantages of each. Bayesian inference is generally employed whenever uncertainty comes to play:

::: {.mini}

There is also a practical advantage of the Bayesian approach, which is that all its inferences are probabilistic and thus can be represented by random simulations. For this reason, whenever we want to summarize uncertainty in estimation beyond simple confidence intervals, and whenever we want to use regression models for predictions, we go Bayesian.

― @gelman2024, P. 16

:::

This is also what Swanson et al. did in [their study](https://wiley.scienceconnect.io/api/oauth/authorize?ui_locales=en&scope=affiliations+alm_identity_ids+login_method+merged_users+openid+settings&response_type=code&redirect_uri=https%3A%2F%2Fesajournals.onlinelibrary.wiley.com%2Faction%2FoidcCallback%3FidpCode%3Dconnect&state=Dps2IO0LOrpSUAYYguc7KjWtugvQmVzeoFmBBK5xyJkimazfO9eomBnInj8FZuI%2F8jXRwy97RozJvLfX0bfaa%2BDV9o8yOFGm%2BJWd4V7EfGEWlrAZpWhHSMRtRE1u3t3vFzi7DuucTU%2F6nmD7Q4gThQ%3D%3D&prompt=none&nonce=gWwRPq7voj4LDNu9cEjyD%2FAEERbNk7ZSuToMur%2FOrmI%3D&client_id=wiley). They adopt the Bayesian framework by assuming a multivariate normal and utilizing Normal-Inverse-Wishart distribution while calculating posterior. To understand this, we still need several concepts checked.

### Random Vector and Multivariate Normal Distribution

Given an individual statistical unit, in our case, the niche described by three isotope ratios, a random vector is a group of variables that describes this mathematical system. Which is again, in our case, those three values of the isotope ratio. The distribution of each component of the random vector together forms a **multivariate distribution**. 

When dealing with univariate analysis, we often assume that the variable is normally distributed (at least in our null hypotheses). We do things likewise even with multivariate analysis. The **multivariate normal distribution** is a generalization of the univariate (one-dimensional) normal distribution into higher dimensions, but it's not as simple as all components of the random vector being normal. It also requires every linear combination of arbitrary two components in the system being normally distributed (bivariate normal distribution), which is not always true even every single variable is normal on their own. And here comes the covariance matrix into play, since a normal distribution is defined by two variables, mean and standard deviation (sd), in which the latter is simply the square root of the variance.

### Covariance and covariance matrix

**Covariance** is a measure of the joint variability of two variables, the sign of the covariance shows the tendency, i.e. one of the three possible linear relationships between two variables, which are:

- negative linear relationship, covariance is \< 0
- no linear relationship, covariance is around 0
- positive linear relationship, covariance is \> 0

The variance is a special case of the covariance in which the two variables are identical. The covariance itself is sensitive to the scale of the data, and it does not provide information of in what extent the two variables correlate with each other and how well the linear correlation fits the data. All these characteristics make covariance difficult to interpret, but it has become an important step stone for many interesting subsequent analysis, such as PCA, correlation analysis, etc.

A **covariance matrix** is a square matrix giving the covariance between each pair of elements, which is always symmetric, and the diagonal elements present the variance of each variable.

::: {.callout-note title="For more information about covariance"}

- [StatQuest](https://www.youtube.com/watch?v=qtaqvPAeEJY) on YouTube (simply and clearly explained)

:::

### Normal-Inverse-Wishart (NIW) distribution

$$
P(x |\text{species}=s) \backsim N(\mu_s \, , \Sigma_s)
$$

**An explanation from [datamicroscope](https://datamicroscopes.github.io/niw.html#:~:text=Since%20the%20normal%20inverse%2DWishart,when%20we%20define%20our%20model.)**:

In practice, real valued data is commonly assumed to be distributed normally, or Gaussian. We could assume that conditioned on species, the measurement data followed a multivariate normal (above mentioned).

The normal inverse-Wishart distribution allows us to learn the underlying parameters of each normal distribution, its mean μs and its covariance $\Sigma_s$. Since the normal inverse-Wishart is the conjugate prior of the multivariate normal, the posterior distribution of a multivariate normal with a normal inverse-Wishart prior also follows a normal inverse-Wishart distribution. This allows us to infer the distirbution over values of $\mu_s$ and $\Sigma_s$ when we define our model.

**The explanation from [wikipedia](https://en.wikipedia.org/wiki/Inverse-Wishart_distribution#:~:text=In%20statistics%2C%20the%20inverse%20Wishart,of%20a%20multivariate%20normal%20distribution.)**:

In statistics, the inverse Wishart distribution, also called the inverted Wishart distribution, is a probability distribution defined on real-valued positive-definite matrices. **In Bayesian statistics it is used as the conjugate prior for the covariance matrix of a multivariate normal distribution**.

**Another explanation from [arxiv](https://arxiv.org/html/2405.16088v1#)**:

The normal-inverse-Wishart (NIW) distribution is commonly used as a prior distribution for the mean ($\mu$) and covariance ($\Sigma$) parameters of a multivariate normal distribution.

**My explanation of this formula**:

The probability of finding a specie given a **normal distribution** ($N$) of $\mu$ as niche parameter mean and $\Sigma$ as niche parameter covariance.

## Simulating random data

First, let's take a view of isotope data of each species:

```{r}
aggregate(fish[2:4], fish[1], mean)
aggregate(fish[2:4], fish[1], sd)
```

### Drawing with `niw.post()`

```{r paged.print=TRUE}
# generate parameter draws from the "default" posteriors of each species
nsamples <- 1000
fish.par <- tapply(1:nrow(fish), fish$species,
            function(ii) niw.post(nsamples = nsamples, X = fish[ii,2:4]))
```

This resamples `nsamples`=`r nsamples` times from NIW distribution for each row in `fish` to generate the simulation data. As we categorized the observation by `fish$species`, we obtain a list of 4 with each of them containing a `nsample` long vector of $\mu$ and $\Sigma$ based on NIW distribution given the original data.

```{r}
# simulation data of the first specie
# num [1:3, 1:3, 1:1000] means a 3x3x1000 multi-dimentional array
str(fish.par[[1]])
```

This step and data structure is critical to later apply `niche.par.plot()`. For such reason, this step can be stored as a function for later utilization:

```{r niche.par.function}
niche.par <- function(data, index, n, pars) {
  par <- tapply(1:nrow(data), INDEX = index,
                function(r) niw.post(nsamples = n, X = data[r, pars]))
}
```

## Visualizing niche parameters

As mentioned above, the description (`?niche.par.plot()`) states the first argument has to be a *list with nspecies = length(niche.par), each element of which is a list with parameters mu and Sigma*. Use `plot.index`, `plot.mu` or `plot.Sigma` to select which $\mu$ or $\Sigma$ to plot, see details in the document.

```{r fig.height=2, fig.align="left"}
clrs <- c("black", "red", "blue", "orange") # colors for each species

# mu1 (del15N), mu2 (del13C), and Sigma12 
par(mar = c(4, 5, .5, .1)+.1, oma = c(0,0,0,0), pty="s", mfrow = c(1,3))
niche.par.plot(fish.par, col = clrs, plot.index = 1)
niche.par.plot(fish.par, col = clrs, plot.index = 2)
niche.par.plot(fish.par, col = clrs, plot.index = 1:2)
legend("topleft", legend = names(fish.par), fill = clrs)
```

### Plot intepretation

## 2-d projection of a subset of a niche region

```{r fig.height=9, fig.width=9, fig.align="center"}
#| label: niche.plot
#| fig-cap: (I believe the same plot in the publication was inappropriately labelled in a reversed order, where the $\delta ^{34} S$ plots here as well in the vignettes is labelled as $\delta ^{15} N$ in the publication, which does not agree with their discussion either)

nsamples <- 10 
fish.par <- tapply(1:nrow(fish), fish$species,
                   function(ii) niw.post(nsamples = nsamples, X = fish[ii,2:4]))

# format data for plotting function
fish.data <- tapply(1:nrow(fish), fish$species, function(ii) X = fish[ii,2:4])

niche.plot(niche.par = fish.par, niche.data = fish.data, pfrac = .05,
           iso.names = expression(delta^{15}*N, delta^{13}*C, delta^{34}*S),
           col = clrs, xlab = expression("Isotope Ratio (per mil)"))
```



## Benthic or pelagic fish???????

